<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>SUPER HUB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* CSSは前回のものから大きな変更なし */
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #111; color: #eee; padding: 15px; }
    h1 { font-size: 2.2rem; color: #00ffff; text-align: center; margin-top: 0; margin-bottom: 0.5rem; }
    p.subtitle { text-align: center; color: #aaa; margin-bottom: 1.2rem; font-size: 0.9rem; }
    .filters-container { margin-bottom: 1rem; }
    #topButtonFilters { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
    #topButtonFilters .filter-btn { padding: 6px 12px; border: 1px solid #333; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, color 0.2s; background-color: #282828; color: #eee; font-size: 0.85rem; }
    #topButtonFilters .filter-btn:hover { background-color: #383838; }
    #topButtonFilters .filter-btn.active { background-color: #00aaaa; color: #000; font-weight: bold; }
    .controls-row { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; padding: 0.5rem 0; }
    #sectionFilters { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
    .section-filter-btn { padding: 6px 12px; border: 1px solid #333; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, color 0.2s; background-color: #282828; color: #eee; font-size: 0.85rem; }
    .section-filter-btn:hover { background-color: #383838; }
    .section-filter-btn.active { background-color: #009999; color: #fff; font-weight: bold; }
    #editSectionBtn, .add-item-form button, .add-section-form-popup button { background-color: #007777; color: #eee; border: 1px solid #333; padding: 7px 14px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; font-size: 0.85rem; height: 34px; box-sizing: border-box; font-weight: normal; }
    #editSectionBtn:hover, .add-item-form button:hover, .add-section-form-popup button:hover { background-color: #009999; }
    .add-item-form input[type="text"], .add-item-form select, .add-section-form-popup input[type="text"] { padding: 7px 9px; border: 1px solid #333; border-radius: 4px; background-color: #282828; color: #eee; font-size: 0.85rem; height: 34px; box-sizing: border-box; }
    .add-item-form { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
    .add-item-form input[type="text"]#itemName { min-width: 140px; }
    .add-item-form select#itemSection { min-width: 100px; }
    .item-list { max-width: 800px; margin: 0 auto; }
    .item { background-color: #222; border: 1px solid #444; border-radius: 8px; padding: 0.8rem 1rem; margin-bottom: 0.8rem; display: flex; justify-content: space-between; align-items: center; }
    .item-details-clickable { flex-grow: 1; cursor: pointer; padding-right: 1rem; }
    .item-name-line { display: flex; align-items: baseline; }
    .item-no { font-size: 0.8em; color: #88dddd; margin-right: 0.5em; }
    .item.loadout { border-color: #00ffff; background-color: #113; }
    .popup-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 15px; }
    .popup { background-color: #222; padding: 20px; border-radius: 10px; width: 100%; max-width: 400px; color: #eee; box-sizing: border-box; }
    .popup input, .popup select, .popup textarea { width: 100%; box-sizing: border-box; margin-bottom: 10px; padding: 8px; background: #111; border: 1px solid #444; color: #fff; border-radius: 4px; }
    .popup input[type="checkbox"] { width: auto; margin-right: 5px; }
    .popup > button { background: #00cccc; border: none; padding: 10px 15px; cursor: pointer; color: #000; font-weight: bold; margin-right: 10px; border-radius: 4px; margin-top: 5px; }
    .popup button.delete-item-btn { background-color: #cc0000; color: #fff; }
    .popup button.delete-item-btn:hover { background-color: #aa0000; }
    .popup-header { font-size: 1.2rem; margin-bottom: 10px; }
    .tags { font-size: 0.85rem; color: #ccc; margin-top: 5px; }
    .locations-container { display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; }
    .location-badge { color: #000; background-color: #00aaaa; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; white-space: nowrap; display: inline-block; transition: transform 0.1s ease; }
    .location-badge.active-filter-highlight { outline: 2px solid #00ffff; box-shadow: 0 0 5px #00ffff; }
    .location-badge.tokyo { background-color: #00ccff; } .location-badge.himeji { background-color: #ffcc00; } .location-badge.baggage { background-color: #ff8888; } .location-badge.car { background-color: #aaffaa; }
    .hidden { display: none !important; }
    .section-editor { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #2a2a2a; padding: 20px; border-radius: 10px; width: 90%; max-width: 450px; color: #eee; z-index: 1001; box-shadow: 0 0 15px rgba(0,0,0,0.5); border: 1px solid #555; box-sizing: border-box; }
    .section-editor h2 { text-align: center; color: #00ffff; margin-top: 0; margin-bottom: 1.5rem; }
    #sectionEditList { list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; }
    #sectionEditList li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #444; }
    #sectionEditList li:last-child { border-bottom: none; }
    #sectionEditList input.rename-input { flex-grow: 1; margin-right: 10px; padding: 8px; background: #111; border: 1px solid #444; color: #fff; border-radius: 4px; }
    #sectionEditList button.delete-btn { background: #ff4444; color: #fff; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    #sectionEditList button.delete-btn:hover { background: #dd2222; }
    .section-editor > div > button { background: #00cccc; border: none; padding: 10px 15px; cursor: pointer; color: #000; font-weight: bold; border-radius: 4px; transition: background 0.2s ease; margin-top: 10px; }
    .section-editor > div > button:hover { background: #00eeee; }
    .add-section-form-popup { margin-top: 1.5rem; border-top: 1px solid #444; padding-top: 1rem; }
    .add-section-form-popup h3 { margin-top:0; margin-bottom: 0.75rem; font-size: 1.1rem; color: #00ffff; text-align: center; }
    .add-section-form-popup input[type="text"] { width: 100%; margin-bottom: 0.75rem; }
    .add-section-form-popup > div { text-align: center; }

    @media (max-width: 768px) { /* Tablet and smaller */
        body { padding: 10px 10px; }
        h1 { font-size: 1.8rem; margin-bottom: 0.3rem; }
        p.subtitle { font-size: 0.8rem; margin-bottom: 1rem; }
        #topButtonFilters .filter-btn { padding: 7px 9px; font-size: 0.75rem; }
        .controls-row { gap: 0.5rem; }
        .section-filter-btn { padding: 7px 9px; font-size: 0.75rem; }
        #editSectionBtn { padding: 7px 10px; font-size: 0.75rem; height: 32px; }
        .add-item-form { flex-direction: column; align-items: stretch; gap: 0.5rem; margin-bottom: 0.8rem; }
        .add-item-form input[type="text"], .add-item-form select, .add-item-form button { width: 100%; margin-bottom: 0.3rem; padding: 9px 10px; font-size: 0.85rem; }
        .add-item-form input[type="text"], .add-item-form select { min-width: 0; height: 34px; }
        .add-item-form button { height: 34px; }
        .item { flex-direction: column; align-items: flex-start; padding: 0.7rem; }
        .item-details-clickable { margin-bottom: 0.6rem; padding-right: 0; width: 100%; }
        .locations-container { justify-content: flex-start; width: 100%; }
        .location-badge { font-size: 0.7rem; padding: 2px 6px; }
    }
    @media (max-width: 480px) { /* Smartphone */
        body { padding: 8px 5px; }
        h1 { font-size: 1.6rem; }
        p.subtitle { font-size: 0.75rem; margin-bottom: 0.75rem; }
        #topButtonFilters .filter-btn { font-size: 0.7rem; padding: 5px 8px; min-width: auto; height: 30px; }
        .controls-row { flex-direction: row; flex-wrap: wrap; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.2rem 0; margin-bottom: 0.6rem; }
        #editSectionBtn { width: auto; padding: 6px 12px; font-size: 0.75rem; height: 30px; flex-shrink: 0; }
        #sectionFilters { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.4rem; flex-grow: 1; }
        .section-filter-btn { width: auto; padding: 5px 10px; font-size: 0.75rem; height: 30px; flex-shrink: 0; }
        .add-item-form { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        /* ItemName input is removed from here in this new flow */
        .add-item-form select#itemSection { flex-grow: 1; min-width: 100px; width: auto; height: 32px; font-size: 0.8rem; padding: 5px 8px; }
        .add-item-form button#addItemBtn { width: auto; padding: 5px 12px; font-size: 0.75rem; height: 32px; flex-shrink: 0; }
        .popup button { width: calc(50% - 5px); margin-right: 5px; font-size: 0.85rem; padding: 8px 10px; }
        .popup button:nth-child(2n) { margin-right: 0; }
    }
  </style>
</head>
<body>
  <h1>SUPER HUB</h1>
  <p class="subtitle">
    This is the terminal board console for managing all parts across all sections.
  </p>

  <div class="filters-container">
    <section id="topButtonFilters"><!-- ... (buttons) ... --></section>
  </div>
  
  <div class="controls-row">
    <button id="editSectionBtn">SECTION EDIT</button>
    <div id="sectionFilters"></div>
  </div>

  <!-- Add Item form now primarily triggers the popup flow -->
  <section class="add-item-form">
    <!-- Item name input is removed, as it will be handled in popup -->
    <!-- Section select can optionally be kept to pre-select section for new item, or removed -->
    <select id="itemSection" style="display: none;"></select> <!-- Keep for logic, but hide if not pre-selecting -->
    <button id="addItemBtn" onclick="addNewItemAndOpenPopup()">Add New Item</button>
  </section>

  <section class="item-list" id="itemList"></section>

  <div class="popup-overlay" id="popupOverlay">
    <div class="popup">
      <div class="popup-header">Item Details</div>
      <!-- Add Item Name input to the popup -->
      <input id="popupItemName" placeholder="Item Name"> 
      <input id="inputSite" placeholder="Purchase Site Name">
      <input id="inputURL" placeholder="URL">
      <input id="inputCount" placeholder="Quantity">
      <div>Location:</div>
        <div id="locationCheckboxes"><!-- ... (checkboxes) ... --></div>
      <input id="inputStatus" placeholder="Condition">
      <textarea id="inputMemo" rows="2" placeholder="Memo..."></textarea>
      <input id="inputTags" placeholder="Tags (comma separated)">
      <label><input type="checkbox" id="inputLoadout"> Include in Loadout</label><br><br>
      <button onclick="savePopup()">Save</button>
      <button onclick="closePopup()">Close</button>
      <button onclick="deleteCurrentItem()" class="delete-item-btn">Delete Item</button>
    </div>
  </div>

  <div id="sectionEditor" class="section-editor hidden">
    <h2>Edit Sections</h2>
    <ul id="sectionEditList"></ul>
    <div class="add-section-form-popup">
        <h3>Add New Section</h3>
        <input type="text" id="newSectionNamePopup" placeholder="New Section Name">
        <div> <button onclick="addSection(true)">Add Section</button> </div>
    </div>
    <div style="text-align:center; margin-top: 1rem;">
      <button onclick="closeSectionEditor()">Close</button>
    </div>
  </div>

<script>
  let items = [];
  let sections = ['wear', 'ec'];
  let currentItem = null; // Holds the item being edited in the popup
  let isNewItemInPopup = false; // Flag to know if popup is for a new item
  let nextItemNo = 1;

  const LOCATION_DETAILS = { /* ... */ };
  let activeLocationFilter = null;
  let showLoadoutFilterActive = false;
  let isAllModeActive = true; 

  function saveToStorage() { /* ... (includes nextItemNo) ... */ }
  function loadFromStorage() { /* ... (includes nextItemNo logic) ... */ }
  function updateTopFilterButtonsUI() { /* ... */ }
  function renderSections() { /* ... */ }

  function renderItems() {
    const itemList = document.getElementById('itemList');
    let itemsToDisplay = items;
    if (!isAllModeActive) { itemsToDisplay = items.filter(/* ... */); }
    const displayedItemsSorted = itemsToDisplay.slice().reverse();
    function renderLocationsHTML(itemLocations) { /* ... */ }
    itemList.innerHTML = '';
    displayedItemsSorted.forEach(item => {
      const div = document.createElement('div');
      div.className = 'item' + (item.loadout ? ' loadout' : ''); 
      div.dataset.itemId = item.id;
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'item-details-clickable';
      const itemNameLine = document.createElement('div');
      itemNameLine.className = 'item-name-line';
      const itemNoSpan = document.createElement('span');
      itemNoSpan.className = 'item-no';
      itemNoSpan.textContent = `No.${item.itemNo || 'N/A'}`;
      const itemNameStrong = document.createElement('strong');
      itemNameStrong.textContent = item.name || "(Untitled)"; // Show (Untitled) if name is empty
      itemNameLine.appendChild(itemNoSpan); itemNameLine.appendChild(itemNameStrong);
      const tagsDiv = document.createElement('div');
      tagsDiv.className = 'tags';
      tagsDiv.textContent = item.tags && item.tags.length > 0 ? item.tags.join(', ') : '';
      detailsDiv.appendChild(itemNameLine); detailsDiv.appendChild(tagsDiv);
      detailsDiv.onclick = () => openPopup(item); // Existing items
      const locationsDiv = document.createElement('div');
      locationsDiv.className = 'locations-container'; 
      locationsDiv.innerHTML = renderLocationsHTML(item.location);
      div.appendChild(detailsDiv); div.appendChild(locationsDiv); 
      itemList.appendChild(div);
    });
    updateTopFilterButtonsUI(); 
    saveToStorage();
  }

  // Renamed addItem to reflect new behavior
  function addNewItemAndOpenPopup() {
    const defaultSection = document.getElementById('itemSection').value || (sections.length > 0 ? sections[0] : undefined);
    
    const newItem = { 
      id: Date.now().toString(36) + Math.random().toString(36).substr(2), 
      itemNo: nextItemNo, // Assign current nextItemNo, increment happens after successful save or handled differently
      name: `New Item (No.${nextItemNo})`, // Temporary name
      section: defaultSection, 
      loadout: false, 
      location: [], 
      tags: [],
      // other fields to empty/default
      site: '', url: '', count: '', status: '', memo: ''
    };
    
    // Add to items array temporarily or handle this carefully
    // items.push(newItem); // Add to the end for now, will be re-rendered
    // currentItem = newItem; // Set as current for the popup
    // isNewItemInPopup = true; // Set flag

    // renderItems(); // Render to show it in the list (might be at the bottom initially before sort)
    openPopup(newItem, true); // Pass a flag to indicate it's a new item
  }


  function openPopup(item, isNew = false) {
    currentItem = item; // This might be an existing item or a new one passed from addNewItemAndOpenPopup
    isNewItemInPopup = isNew;

    document.getElementById('popupOverlay').style.display = 'flex';
    
    // Populate popup fields
    const popupHeader = document.querySelector('.popup-header');
    const itemNameInput = document.getElementById('popupItemName'); // New input for item name

    if (isNew) {
        // For new items, set defaults or clear fields
        itemNameInput.value = ""; // Clear for user to type, or use item.name as placeholder
        itemNameInput.placeholder = item.name; // Show temporary name as placeholder
        if(popupHeader) popupHeader.textContent = `Add New Item (No.${item.itemNo})`;
        document.getElementById('inputSite').value = '';
        document.getElementById('inputURL').value = '';
        document.getElementById('inputCount').value = '1'; // Default quantity
        document.getElementById('inputStatus').value = '';
        document.getElementById('inputMemo').value = '';
        document.getElementById('inputTags').value = '';
        document.getElementById('inputLoadout').checked = false;
        document.querySelectorAll('.locCheck').forEach(cb => cb.checked = false);
        
        // Temporarily add to items array if it's truly new and not yet in the list.
        // This is tricky if we want to cancel. A better way is to only add on successful save.
        // For now, let's assume 'item' passed IS the new item object, already given a temp name and itemNo.
    } else {
        // For existing items
        itemNameInput.value = item.name || '';
        itemNameInput.placeholder = "Item Name";
        if(popupHeader) popupHeader.textContent = `Item Details (No.${item.itemNo || 'N/A'})`;
        document.getElementById('inputSite').value = item.site || '';
        document.getElementById('inputURL').value = item.url || '';
        document.getElementById('inputCount').value = item.count || '';
        document.getElementById('inputStatus').value = item.status || '';
        document.getElementById('inputMemo').value = item.memo || '';
        document.getElementById('inputTags').value = item.tags && Array.isArray(item.tags) ? item.tags.join(', ') : '';
        document.getElementById('inputLoadout').checked = item.loadout || false;
        document.querySelectorAll('.locCheck').forEach(cb => {
          cb.checked = Array.isArray(item.location) && item.location.includes(cb.value);
        });
    }
  }
                                                   
  function savePopup() {
    if (!currentItem) return;

    const itemNameFromPopup = document.getElementById('popupItemName').value.trim();
    if (!itemNameFromPopup) {
        alert("Item name cannot be empty.");
        document.getElementById('popupItemName').focus();
        return;
    }

    // Update currentItem with popup data
    currentItem.name = itemNameFromPopup;
    currentItem.site = document.getElementById('inputSite').value;
    currentItem.url = document.getElementById('inputURL').value;
    currentItem.count = document.getElementById('inputCount').value;
    currentItem.status = document.getElementById('inputStatus').value;
    currentItem.memo = document.getElementById('inputMemo').value;
    currentItem.tags = document.getElementById('inputTags').value.split(',').map(t => t.trim()).filter(t => t);
    currentItem.loadout = document.getElementById('inputLoadout').checked;
    currentItem.location = [...document.querySelectorAll('.locCheck:checked')].map(cb => cb.value);

    if (isNewItemInPopup) {
        // It's a new item, officially add it to the list if not already, and increment master itemNo
        const existingItemIndex = items.findIndex(i => i.id === currentItem.id);
        if (existingItemIndex === -1) { // Should not happen if handled correctly in addNewItem...
            items.push(currentItem); // Add if somehow not pushed yet
        }
        // The itemNo was already assigned when `addNewItemAndOpenPopup` created `newItem`
        // So, we just need to ensure `nextItemNo` is incremented for the *next* new item.
        if (currentItem.itemNo >= nextItemNo) { // If the current new item used up nextItemNo
            nextItemNo = currentItem.itemNo + 1;
        }
        isNewItemInPopup = false; // Reset flag
    }
    
    renderItems(); // This will save to storage
    closePopup();
  }

  function closePopup() { 
    if (isNewItemInPopup && currentItem) {
        // If it was a new item popup and it's closed without saving a proper name,
        // or if we decide to always remove on close if new:
        // items = items.filter(item => item.id !== currentItem.id); // Remove the temp item
        // For now, let's assume savePopup handles adding it. If closed, it's just closed.
        // If the item name is still the temporary one, it means it wasn't properly saved.
        const itemNameFromPopup = document.getElementById('popupItemName').value.trim();
        if (!itemNameFromPopup || currentItem.name === `New Item (No.${currentItem.itemNo})`) {
            // Optionally remove if no valid name was set.
            // For simplicity now, we don't remove. User must save.
        }
    }
    isNewItemInPopup = false; // Reset flag regardless
    document.getElementById('popupOverlay').style.display = 'none'; 
    const popupHeader = document.querySelector('.popup-header');
    if(popupHeader) popupHeader.textContent = `Item Details`; // Reset header
    currentItem = null; 
    // renderItems(); // Render if an item was potentially removed (not doing that now on close)
  }

  function deleteCurrentItem() {
    if (currentItem && confirm(`Are you sure you want to delete item "${currentItem.name}" (No.${currentItem.itemNo})?`)) {
      items = items.filter(item => item.id !== currentItem.id);
      renderItems(); 
      closePopup();
    }
  }
  
  // editSectionBtn, addSection, top filter listeners remain the same
  document.getElementById('editSectionBtn').onclick = function(){ /* ... */ };
  function addSection(isFromPopup = false){ /* ... */ };
  document.querySelectorAll('#topButtonFilters .filter-btn').forEach(button => { /* ... */ });


  loadFromStorage();
  renderSections(); 
  renderItems();
</script>
</body>
</html>
