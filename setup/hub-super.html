<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SUPER HUB</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: #eee;
      padding: 20px;
    }
    h1 {
      font-size: 2.5rem;
      color: #00ffff;
      text-align: center;
    }
    p.subtitle {
      text-align: center;
      color: #aaa;
      margin-bottom: 2rem;
    }

    .filters, .add-item-form, .add-section-form {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .item-list {
      max-width: 800px;
      margin: 0 auto;
    }

    .item {
      background-color: #222;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .item.loadout {
      border-color: #00ffff;
      background-color: #113;
    }

    .popup-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup {
      background-color: #222;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      color: #eee;
    }

    .popup input, .popup select, .popup textarea {
      width: 100%;
      box-sizing: border-box; /* Added for consistent sizing */
      margin-bottom: 10px;
      padding: 6px;
      background: #111;
      border: 1px solid #444;
      color: #fff;
    }

    .popup button {
      background: #00cccc;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      color: #000;
      font-weight: bold;
      margin-right: 10px;
    }

    .popup-header {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .tags {
      font-size: 0.85rem;
      color: #ccc;
      margin-top: 5px;
    }

    .locations { /* Added to align location badges */
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .location-badge {
      color: #000;
      background-color: #00aaaa;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-left: 6px;
      font-weight: 500;
      white-space: nowrap;
      display: inline-block;
    }

    .location-badge.tokyo { background-color: #00ccff; }
    .location-badge.himeji { background-color: #ffcc00; }
    .location-badge.baggage { background-color: #ff8888; }
    .location-badge.car { background-color: #aaffaa; }

    #editSectionBtn {
      background: #00cccc;
      color: #000;
      border: none;
      padding: 8px 14px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    #editSectionBtn:hover {
      background: #00eeee;
    }

    /* Styles for Section Editor */
    .hidden {
      display: none !important;
    }

    .section-editor {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #2a2a2a; /* Slightly different from popup for distinction */
      padding: 20px;
      border-radius: 10px;
      width: 450px;
      color: #eee;
      z-index: 1001; /* Ensure it's above popup if they can overlap */
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      border: 1px solid #555;
    }

    .section-editor h2 {
      text-align: center;
      color: #00ffff;
      margin-top: 0;
      margin-bottom: 1.5rem;
    }

    #sectionEditList {
      list-style-type: none;
      padding: 0;
      max-height: 300px; /* Added for scrollability if many sections */
      overflow-y: auto; /* Added for scrollability */
    }

    #sectionEditList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #444;
    }
    #sectionEditList li:last-child {
      border-bottom: none;
    }

    #sectionEditList input.rename-input {
      flex-grow: 1;
      margin-right: 10px;
      padding: 6px;
      background: #111;
      border: 1px solid #444;
      color: #fff;
      border-radius: 4px;
    }

    #sectionEditList button.delete-btn {
      background: #ff4444;
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    #sectionEditList button.delete-btn:hover {
      background: #dd2222;
    }

    .section-editor button { /* General button styling within section editor, e.g., Close button */
      background: #00cccc;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      color: #000;
      font-weight: bold;
      border-radius: 4px;
      transition: background 0.2s ease;
    }
    .section-editor button:hover {
      background: #00eeee;
    }
  </style>
</head>
<body>
  <h1>SUPER HUB</h1>
  <p class="subtitle">
    This is the terminal board console for managing all parts — from enduring equipment to expendable inventory — across all sections.
  </p>

  <section class="filters">
    <label><input type="checkbox" id="toggleLoadout" /> Show Loadout Only</label>
    <label><input type="radio" name="type" value="all" checked /> All</label>
    <label><input type="radio" name="type" value="equipment" /> Equipment</label>
    <label><input type="radio" name="type" value="inventory" /> Inventory</label>
  </section>

  <section class="filters" id="sectionFilters"></section>
  
  <section style="text-align: center; margin-bottom: 1.5rem;">
    <button id="editSectionBtn">SECTION EDIT</button>
  </section>

  <section class="add-section-form">
    <input type="text" id="newSectionName" placeholder="New Section (e.g., tools)">
    <button onclick="addSection()">Add Section</button>
  </section>

  <section class="add-item-form">
    <input type="text" id="itemName" placeholder="Item name">
    <select id="itemType">
      <option value="equipment">Equipment</option>
      <option value="inventory">Inventory</option>
    </select>
    <select id="itemSection"></select>
    <button onclick="addItem()">Add Item</button>
  </section>

  <section class="item-list" id="itemList"></section>

  <!-- Popup -->
  <div class="popup-overlay" id="popupOverlay">
    <div class="popup">
      <div class="popup-header">Item Details</div>
      <input id="inputSite" placeholder="Purchase Site Name">
      <input id="inputURL" placeholder="URL">
      <input id="inputCount" placeholder="Quantity">
      <div>Location:</div>
        <div id="locationCheckboxes">
          <label><input type="checkbox" class="locCheck" value="tokyo"> Tokyo</label>
          <label><input type="checkbox" class="locCheck" value="himeji"> Himeji</label>
          <label><input type="checkbox" class="locCheck" value="baggage"> Baggage</label>
          <label><input type="checkbox" class="locCheck" value="car"> Car</label>
      </div>
      <input id="inputStatus" placeholder="Condition">
      <textarea id="inputMemo" rows="2" placeholder="Memo..."></textarea>
      <input id="inputTags" placeholder="Tags (comma separated)">
      <label><input type="checkbox" id="inputLoadout"> Include in Loadout</label><br><br>
      <button onclick="savePopup()">Save</button>
      <button onclick="closePopup()">Close</button>
    </div>
  </div>

  <!-- SECTION EDIT PANEL -->
  <div id="sectionEditor" class="section-editor hidden"> <!-- MOVED HERE and added class -->
    <h2>Edit Sections</h2>
    <ul id="sectionEditList"></ul>
    <div style="text-align:center; margin-top: 1rem;">
      <button onclick="closeSectionEditor()">Close</button>
    </div>
  </div>

<script>
  let items = [];
  let sections = ['wear', 'ec'];
  let currentItem = null;

  function saveToStorage() {
    localStorage.setItem('superhub_items', JSON.stringify(items));
    localStorage.setItem('superhub_sections', JSON.stringify(sections));
  }

  function loadFromStorage() {
    const savedItems = localStorage.getItem('superhub_items');
    const savedSections = localStorage.getItem('superhub_sections');
    if (savedItems) items = JSON.parse(savedItems);
    if (savedSections) sections = JSON.parse(savedSections);
  }

  function renderSections() {
    const sectionFilters = document.getElementById('sectionFilters');
    const sectionSelect = document.getElementById('itemSection');
    sectionFilters.innerHTML = '';
    sectionSelect.innerHTML = '';

    sections.forEach(sec => {
      const checkbox = document.createElement('label');
      checkbox.innerHTML = `<input type="checkbox" class="sectionFilter" value="${sec}" checked> ${sec}`;
      sectionFilters.appendChild(checkbox);

      const option = document.createElement('option');
      option.value = sec;
      option.textContent = sec;
      sectionSelect.appendChild(option);
    });

    document.querySelectorAll('.sectionFilter').forEach(cb =>
      cb.addEventListener('change', renderItems)
    );
  }

  function renderItems() {
    const itemList = document.getElementById('itemList');
    const showLoadoutOnly = document.getElementById('toggleLoadout').checked;
    const selectedType = [...document.querySelectorAll('input[name="type"]')].find(r => r.checked).value;
    const selectedSections = [...document.querySelectorAll('.sectionFilter')].filter(cb => cb.checked).map(cb => cb.value);

    const filtered = items.filter(item => {
      if (showLoadoutOnly && !item.loadout) return false;
      if (selectedType !== "all" && item.type !== selectedType) return false;
      if (!selectedSections.includes(item.section)) return false;
      return true;
    });

    // Corrected renderLocations function
    function renderLocations(locArray) {
      if (!Array.isArray(locArray) || locArray.length === 0) return '';
      const labelMap = {
        tokyo: '東京',
        himeji: '姫路',
        baggage: '手荷物',
        car: '車'
      };
      return locArray.map(loc => {
        return `<span class="location-badge ${loc}">${labelMap[loc] || loc}</span>`;
      }).join('');
    }

    itemList.innerHTML = '';
    filtered.forEach((item) => { // Removed index as it's not used here
      const div = document.createElement('div');
      div.className = 'item' + (item.loadout ? ' loadout' : '');
      div.innerHTML = `
        <div>
          <div><strong>${item.name}</strong></div>
          <div class="tags">${item.tags ? item.tags.join(', ') : ''}</div>
        </div>
        <div class="locations">${renderLocations(item.location)}</div>
      `;

      div.onclick = () => openPopup(item);
      itemList.appendChild(div);
    });

    saveToStorage();
  }

  function addItem() {
    const name = document.getElementById('itemName').value;
    const type = document.getElementById('itemType').value;
    const section = document.getElementById('itemSection').value;
    if (name.trim()) {
      items.push({ name, type, section, loadout: false, location: [] }); // Added empty location array
      document.getElementById('itemName').value = '';
      renderItems();
    }
  }

  document.getElementById('editSectionBtn').onclick = function () {
    const editor = document.getElementById('sectionEditor');
    const list = document.getElementById('sectionEditList');
    list.innerHTML = '';

    sections.forEach((sec, index) => {
      const li = document.createElement('li');

      const input = document.createElement('input');
      input.type = 'text';
      input.value = sec;
      input.className = 'rename-input';

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = '✕';
      deleteBtn.onclick = () => {
        if (confirm(`Delete section "${sec}"? This will remove the section from all associated items.`)) {
          const sectionToDelete = sections[index]; // Store before splice
          sections.splice(index, 1);
          
          items.forEach(item => {
            if (item.section === sectionToDelete) {
              // Optionally, assign to a default section or mark as 'unsectioned'
              // For now, just removing it. Consider user experience here.
              delete item.section; 
            }
          });
          saveToStorage();
          renderSections();
          renderItems();
          // Re-render the editor list
          document.getElementById('editSectionBtn').click(); 
        }
      };

      input.onchange = () => {
        const oldName = sec; // Capture current section name for item update
        const newName = input.value.trim().toLowerCase();
        if (newName && newName !== oldName && !sections.includes(newName)) {
          sections[index] = newName;
          items.forEach(item => {
            if (item.section === oldName) {
              item.section = newName;
            }
          });
          saveToStorage();
          renderSections();
          renderItems();
          // Re-render the editor list (optional, as name change is reflected)
          // document.getElementById('editSectionBtn').click(); // Could cause flicker, test if needed
        } else if (newName !== oldName) { // Name is invalid or duplicate
          alert(`Section name "${newName}" is invalid or already exists.`);
          input.value = oldName; // Revert
        }
      };

      li.appendChild(input);
      li.appendChild(deleteBtn);
      list.appendChild(li);
    });

    editor.classList.remove('hidden');
  };

  function closeSectionEditor() {
    document.getElementById('sectionEditor').classList.add('hidden');
  }

  function addSection() {
    const nameInput = document.getElementById('newSectionName');
    const name = nameInput.value.trim().toLowerCase();
    if (name && !sections.includes(name)) {
      sections.push(name);
      nameInput.value = '';
      saveToStorage(); // Save after adding section
      renderSections();
      renderItems(); // renderItems will call saveToStorage again, but that's okay
    } else if (sections.includes(name)) {
      alert(`Section "${name}" already exists.`);
    } else if (!name) {
      alert("Section name cannot be empty.");
    }
  }

  function openPopup(item) {
    currentItem = item;
    document.getElementById('popupOverlay').style.display = 'flex';
    document.getElementById('inputSite').value = item.site || '';
    document.getElementById('inputURL').value = item.url || '';
    document.getElementById('inputCount').value = item.count || '';
    document.getElementById('inputStatus').value = item.status || '';
    document.getElementById('inputMemo').value = item.memo || '';
    document.getElementById('inputTags').value = item.tags ? item.tags.join(', ') : '';
    document.getElementById('inputLoadout').checked = item.loadout || false;

    document.querySelectorAll('.locCheck').forEach(cb => {
      cb.checked = Array.isArray(item.location) && item.location.includes(cb.value);
    });
  }
                                                   
  function savePopup() {
    if (currentItem) {
      currentItem.site = document.getElementById('inputSite').value;
      currentItem.url = document.getElementById('inputURL').value;
      currentItem.count = document.getElementById('inputCount').value;
      currentItem.status = document.getElementById('inputStatus').value;
      currentItem.memo = document.getElementById('inputMemo').value;
      currentItem.tags = document.getElementById('inputTags').value
        .split(',').map(t => t.trim()).filter(t => t);
      currentItem.loadout = document.getElementById('inputLoadout').checked;

      currentItem.location = [...document.querySelectorAll('.locCheck')]
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      renderItems(); // This will call saveToStorage
      closePopup();
    }
  }

  function closePopup() {
    document.getElementById('popupOverlay').style.display = 'none';
  }
  
  // Initial setup
  loadFromStorage();
  renderSections();
  renderItems();

  document.querySelectorAll('input[name="type"], #toggleLoadout')
    .forEach(el => el.addEventListener('change', renderItems));
</script>
</body>
</html>
