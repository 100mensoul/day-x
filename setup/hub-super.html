<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>SUPER HUB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* CSSは前回のものから変更なし */
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: #eee;
      padding: 15px;
    }
    h1 {
      font-size: 2.2rem;
      color: #00ffff;
      text-align: center;
      margin-top: 0;
      margin-bottom: 0.5rem;
    }
    p.subtitle {
      text-align: center;
      color: #aaa;
      margin-bottom: 1.2rem;
      font-size: 0.9rem;
    }

    .filters-container {
      margin-bottom: 1rem;
    }

    #topButtonFilters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
    }
    #topButtonFilters .filter-btn {
        padding: 6px 12px;
        border: 1px solid #333;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        background-color: #282828;
        color: #eee;
        font-size: 0.85rem;
    }
    #topButtonFilters .filter-btn:hover {
        background-color: #383838;
    }
    #topButtonFilters .filter-btn.active {
        background-color: #00aaaa;
        color: #000;
        font-weight: bold;
    }

    .controls-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding: 0.5rem 0;
    }

    #sectionFilters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
    }
    .section-filter-btn {
        padding: 6px 12px;
        border: 1px solid #333;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        background-color: #282828;
        color: #eee;
        font-size: 0.85rem;
    }
    .section-filter-btn:hover {
        background-color: #383838;
    }
    .section-filter-btn.active {
        background-color: #009999;
        color: #fff;
        font-weight: bold;
    }


    #editSectionBtn {
      background: #00cccc;
      color: #000;
      border: none;
      padding: 7px 14px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 0.85rem;
      height: 34px;
      box-sizing: border-box;
    }
    #editSectionBtn:hover {
      background: #00eeee;
    }
    
    .add-section-form-inline {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .add-section-form-inline input[type="text"],
    .add-section-form-inline button {
        padding: 7px 9px;
        border: 1px solid #333;
        border-radius: 4px;
        background-color: #282828;
        color: #eee;
        font-size: 0.85rem;
        height: 34px;
        box-sizing: border-box;
    }
    .add-section-form-inline input[type="text"] {
        min-width: 130px;
    }
    .add-section-form-inline button {
        cursor: pointer;
        background-color: #007777;
    }
    .add-section-form-inline button:hover {
        background-color: #009999;
    }

    .add-item-form {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .add-item-form input, .add-item-form select, .add-item-form button {
        padding: 7px 9px;
        border: 1px solid #333;
        border-radius: 4px;
        background-color: #282828;
        color: #eee;
        font-size: 0.9rem;
        height: 36px;
        box-sizing: border-box;
    }
    .add-item-form button {
        cursor: pointer;
        background-color: #007777;
    }
    .add-item-form button:hover {
        background-color: #009999;
    }
    .add-item-form input, .add-item-form select {
        min-width: 140px;
    }


    .item-list {
      max-width: 800px;
      margin: 0 auto;
    }

    .item {
      background-color: #222;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .item-details-clickable {
        flex-grow: 1;
        cursor: pointer;
        padding-right: 1rem;
    }
    .item.loadout {
      border-color: #00ffff;
      background-color: #113;
    }

    .popup-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 15px;
    }
    .popup {
      background-color: #222;
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 400px;
      color: #eee;
      box-sizing: border-box;
    }
    .popup input, .popup select, .popup textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 10px;
      padding: 8px;
      background: #111;
      border: 1px solid #444;
      color: #fff;
      border-radius: 4px;
    }
    .popup input[type="checkbox"] {
        width: auto;
        margin-right: 5px;
    }
    .popup button {
      background: #00cccc;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      color: #000;
      font-weight: bold;
      margin-right: 10px;
      border-radius: 4px;
      margin-top: 5px;
    }
    .popup button.delete-item-btn {
        background-color: #cc0000;
        color: #fff;
    }
    .popup button.delete-item-btn:hover {
        background-color: #aa0000;
    }
    .popup-header {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }
    .tags {
      font-size: 0.85rem;
      color: #ccc;
      margin-top: 5px;
    }
    .locations-container {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    .location-badge {
      color: #000;
      background-color: #00aaaa;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
      display: inline-block;
      transition: transform 0.1s ease;
    }
    .location-badge.active-filter-highlight {
        outline: 2px solid #00ffff;
        box-shadow: 0 0 5px #00ffff;
    }
    .location-badge.tokyo { background-color: #00ccff; }
    .location-badge.himeji { background-color: #ffcc00; }
    .location-badge.baggage { background-color: #ff8888; }
    .location-badge.car { background-color: #aaffaa; }

    .hidden { display: none !important; }
    .section-editor {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background-color: #2a2a2a;
      padding: 20px; border-radius: 10px;
      width: 90%; max-width: 450px;
      color: #eee; z-index: 1001;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      border: 1px solid #555; box-sizing: border-box;
    }
    .section-editor h2 {
      text-align: center; color: #00ffff;
      margin-top: 0; margin-bottom: 1.5rem;
    }
    #sectionEditList {
      list-style-type: none; padding: 0;
      max-height: 300px; overflow-y: auto;
    }
    #sectionEditList li {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid #444;
    }
    #sectionEditList li:last-child { border-bottom: none; }
    #sectionEditList input.rename-input {
      flex-grow: 1; margin-right: 10px; padding: 8px;
      background: #111; border: 1px solid #444;
      color: #fff; border-radius: 4px;
    }
    #sectionEditList button.delete-btn {
      background: #ff4444; color: #fff; border: none;
      padding: 6px 10px; border-radius: 4px;
      cursor: pointer; font-weight: bold;
    }
    #sectionEditList button.delete-btn:hover { background: #dd2222; }
    .section-editor button {
      background: #00cccc; border: none;
      padding: 10px 15px; cursor: pointer;
      color: #000; font-weight: bold;
      border-radius: 4px; transition: background 0.2s ease;
      margin-top: 10px;
    }
    .section-editor button:hover { background: #00eeee; }

    @media (max-width: 768px) {
        body { padding: 10px 10px; }
        h1 { font-size: 1.8rem; margin-bottom: 0.3rem; }
        p.subtitle { font-size: 0.8rem; margin-bottom: 1rem; }
        #topButtonFilters .filter-btn { padding: 7px 9px; font-size: 0.75rem; }
        .controls-row { gap: 0.5rem; justify-content: space-around; }
        .section-filter-btn { padding: 7px 9px; font-size: 0.75rem; }
        #editSectionBtn { padding: 7px 10px; font-size: 0.75rem; height: 32px; }
        .add-section-form-inline input[type="text"],
        .add-section-form-inline button { padding: 7px 8px; font-size: 0.75rem; height: 32px; }
        .add-section-form-inline input[type="text"] { min-width: 100px; flex-grow: 1; }
        .add-item-form { flex-direction: column; align-items: stretch; gap: 0.5rem; margin-bottom: 0.8rem; }
        .add-item-form input, .add-item-form select, .add-item-form button { width: 100%; margin-bottom: 0.3rem; padding: 9px 10px; font-size: 0.85rem; }
        .add-item-form input, .add-item-form select { min-width: 0; }
        .item { flex-direction: column; align-items: flex-start; padding: 0.7rem; }
        .item-details-clickable { margin-bottom: 0.6rem; padding-right: 0; width: 100%; }
        .locations-container { justify-content: flex-start; width: 100%; }
        .location-badge { font-size: 0.7rem; padding: 2px 6px; }
    }
    @media (max-width: 480px) {
        body { padding: 8px 5px; }
        h1 { font-size: 1.6rem; }
        p.subtitle { font-size: 0.75rem; margin-bottom: 0.75rem; }
        #topButtonFilters .filter-btn { font-size: 0.7rem; padding: 6px 7px; min-width: 55px; }
        .controls-row { flex-direction: column; align-items: stretch; }
        #sectionFilters { justify-content: stretch; }
        .section-filter-btn, #editSectionBtn,
        .add-section-form-inline input[type="text"],
        .add-section-form-inline button { width: 100%; margin-bottom: 0.3rem; box-sizing: border-box; }
        .add-section-form-inline { flex-direction: column; width: 100%; }
        .popup button { width: calc(50% - 5px); margin-right: 5px; font-size: 0.85rem; padding: 8px 10px; }
        .popup button:nth-child(2n) { margin-right: 0; }
    }
  </style>
</head>
<body>
  <h1>SUPER HUB</h1>
  <p class="subtitle">
    This is the terminal board console for managing all parts across all sections.
  </p>

  <div class="filters-container">
    <section id="topButtonFilters">
      <button data-filter-type="all" class="filter-btn active">ALL</button>
      <button data-filter-type="loadlist" class="filter-btn">LOADLIST</button>
      <button data-filter-type="location" data-location="tokyo" class="filter-btn">東京</button>
      <button data-filter-type="location" data-location="himeji" class="filter-btn">姫路</button>
      <button data-filter-type="location" data-location="baggage" class="filter-btn">手荷物</button>
      <button data-filter-type="location" data-location="car" class="filter-btn">車</button>
    </section>
  </div>
  
  <div class="controls-row">
    <div id="sectionFilters"></div>
    <button id="editSectionBtn">SECTION EDIT</button>
    <div class="add-section-form-inline">
      <input type="text" id="newSectionName" placeholder="New Section">
      <button onclick="addSection()">Add Section</button>
    </div>
  </div>

  <section class="add-item-form">
    <input type="text" id="itemName" placeholder="Item name">
    <select id="itemSection"></select>
    <button onclick="addItem()">Add Item</button>
  </section>

  <section class="item-list" id="itemList"></section>

  <div class="popup-overlay" id="popupOverlay">
    <div class="popup">
      <div class="popup-header">Item Details</div>
      <input id="inputSite" placeholder="Purchase Site Name">
      <input id="inputURL" placeholder="URL">
      <input id="inputCount" placeholder="Quantity">
      <div>Location:</div>
        <div id="locationCheckboxes">
          <label><input type="checkbox" class="locCheck" value="tokyo"> Tokyo</label>
          <label><input type="checkbox" class="locCheck" value="himeji"> Himeji</label>
          <label><input type="checkbox" class="locCheck" value="baggage"> Baggage</label>
          <label><input type="checkbox" class="locCheck" value="car"> Car</label>
      </div>
      <input id="inputStatus" placeholder="Condition">
      <textarea id="inputMemo" rows="2" placeholder="Memo..."></textarea>
      <input id="inputTags" placeholder="Tags (comma separated)">
      <label><input type="checkbox" id="inputLoadout"> Include in Loadout</label><br><br>
      <button onclick="savePopup()">Save</button>
      <button onclick="closePopup()">Close</button>
      <button onclick="deleteCurrentItem()" class="delete-item-btn">Delete Item</button>
    </div>
  </div>

  <div id="sectionEditor" class="section-editor hidden">
    <h2>Edit Sections</h2>
    <ul id="sectionEditList"></ul>
    <div style="text-align:center; margin-top: 1rem;">
      <button onclick="closeSectionEditor()">Close</button>
    </div>
  </div>

<script>
  let items = [];
  let sections = ['wear', 'ec'];
  let currentItem = null;

  const LOCATION_DETAILS = {
    'tokyo': { label: '東京', class: 'tokyo' },
    'himeji': { label: '姫路', class: 'himeji' },
    'baggage': { label: '手荷物', class: 'baggage' },
    'car': { label: '車', class: 'car' }
  };

  // Filter states
  let activeLocationFilter = null;
  let showLoadoutFilterActive = false;
  let isAllModeActive = true; // Initialize with ALL mode active

  function saveToStorage() {
    localStorage.setItem('superhub_items', JSON.stringify(items));
    localStorage.setItem('superhub_sections', JSON.stringify(sections));
  }

  function loadFromStorage() {
    const savedItems = localStorage.getItem('superhub_items');
    const savedSections = localStorage.getItem('superhub_sections');
    if (savedItems) items = JSON.parse(savedItems);
    if (savedSections) sections = JSON.parse(savedSections);
    if (sections.length === 0 && items.some(item => item.section)) {
        const uniqueSectionsFromItems = [...new Set(items.map(item => item.section).filter(Boolean))];
        if (uniqueSectionsFromItems.length > 0) sections = uniqueSectionsFromItems;
    }
    items.forEach(item => {
        if (!item.location) item.location = [];
        if (!item.tags) item.tags = [];
        if (!item.id) item.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
    });
  }

  function updateTopFilterButtonsUI() {
    document.querySelectorAll('#topButtonFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
    
    const allBtn = document.querySelector('#topButtonFilters .filter-btn[data-filter-type="all"]');
    if (isAllModeActive) {
        if (allBtn) allBtn.classList.add('active');
    } else {
        if (allBtn) allBtn.classList.remove('active'); // Explicitly remove if not in ALL mode

        const loadlistBtn = document.querySelector('#topButtonFilters .filter-btn[data-filter-type="loadlist"]');
        if (showLoadoutFilterActive) {
            if(loadlistBtn) loadlistBtn.classList.add('active');
        }
        if (activeLocationFilter) {
            const locBtn = document.querySelector(`#topButtonFilters .filter-btn[data-location="${activeLocationFilter}"]`);
            if (locBtn) locBtn.classList.add('active');
        }
    }
  }


  function renderSections() {
    const sectionFiltersContainer = document.getElementById('sectionFilters');
    const sectionSelectDropdown = document.getElementById('itemSection');
    sectionFiltersContainer.innerHTML = '';
    sectionSelectDropdown.innerHTML = '';

    // Retrieve current active sections before re-rendering, if any.
    // This is to preserve selection state unless ALL is clicked.
    const previouslyActiveSections = [...document.querySelectorAll('#sectionFilters .section-filter-btn.active')].map(btn => btn.dataset.section);


    sections.forEach(sec => {
      const button = document.createElement('button');
      button.className = 'section-filter-btn';
      button.textContent = sec;
      button.dataset.section = sec;

      // Set initial active state for section buttons
      // If isAllModeActive is true, all sections are conceptually "active" for display, but filter is bypassed.
      // If not in ALL mode, restore previous selection or default to active.
      if (isAllModeActive || (previouslyActiveSections.length === 0 && sections.length > 0) || previouslyActiveSections.includes(sec)) {
          button.classList.add('active');
      }


      button.onclick = () => {
        isAllModeActive = false; // Any section interaction deactivates ALL mode
        button.classList.toggle('active');
        renderItems();
      };
      sectionFiltersContainer.appendChild(button);

      const option = document.createElement('option');
      option.value = sec;
      option.textContent = sec;
      sectionSelectDropdown.appendChild(option);
    });

    if (sections.length === 0) {
        if (sectionSelectDropdown.options.length === 0) {
            const noSectionOption = document.createElement('option');
            noSectionOption.value = ""; noSectionOption.textContent = "No sections defined";
            noSectionOption.disabled = true; sectionSelectDropdown.appendChild(noSectionOption);
        }
    }
  }

  function renderItems() {
    const itemList = document.getElementById('itemList');
    
    let itemsToDisplay = items;

    if (!isAllModeActive) { // Only apply filters if not in ALL mode
        itemsToDisplay = items.filter(item => {
            if (showLoadoutFilterActive && !item.loadout) return false;

            if (activeLocationFilter) {
                if (!item.location || !Array.isArray(item.location) || !item.location.includes(activeLocationFilter)) {
                return false;
                }
            }

            // Section filter logic (only if not in ALL mode)
            const selectedSectionButtons = [...document.querySelectorAll('#sectionFilters .section-filter-btn.active')];
            const selectedSections = selectedSectionButtons.map(btn => btn.dataset.section);
            const sectionButtonsExist = document.querySelectorAll('#sectionFilters .section-filter-btn').length > 0;

            if (sectionButtonsExist) {
                if (selectedSections.length > 0) {
                    if (!item.section || !selectedSections.includes(item.section)) {
                        return false;
                    }
                } else {
                    return false; 
                }
            }
            return true;
        });
    }

    function renderLocationsHTML(itemLocations) {
      if (!Array.isArray(itemLocations) || itemLocations.length === 0) return '';
      return itemLocations.map(locKey => {
        const locDetail = LOCATION_DETAILS[locKey];
        if (!locDetail) return `<span class="location-badge">${locKey}</span>`;
        let badgeClass = `location-badge ${locDetail.class}`;
        // Highlight badge if it matches the active top filter (even in ALL mode, for visual consistency if a location was last active)
        if (locKey === activeLocationFilter && !isAllModeActive) { 
            badgeClass += ' active-filter-highlight';
        }
        return `<span class="${badgeClass}">${locDetail.label}</span>`;
      }).join('');
    }

    itemList.innerHTML = '';
    itemsToDisplay.forEach(item => { // Iterate over potentially filtered list
      const div = document.createElement('div');
      div.className = 'item' + (item.loadout ? ' loadout' : '');
      div.dataset.itemId = item.id;
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'item-details-clickable';
      detailsDiv.innerHTML = `
        <div><strong>${item.name}</strong></div>
        <div class="tags">${item.tags && item.tags.length > 0 ? item.tags.join(', ') : ''}</div>
      `;
      detailsDiv.onclick = () => openPopup(item);
      const locationsDiv = document.createElement('div');
      locationsDiv.className = 'locations-container';
      locationsDiv.innerHTML = renderLocationsHTML(item.location);
      div.appendChild(detailsDiv);
      div.appendChild(locationsDiv);
      itemList.appendChild(div);
    });

    updateTopFilterButtonsUI();
    saveToStorage();
  }

  function addItem() {
    const nameInput = document.getElementById('itemName');
    const section = document.getElementById('itemSection').value;
    const name = nameInput.value.trim();
    if (name) {
      const newItem = { 
        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
        name, section: section || undefined,
        loadout: false, location: [], tags: [] 
      };
      items.push(newItem);
      nameInput.value = '';
      // Adding an item should not change the ALL mode status unless explicitly desired
      // isAllModeActive = false; // Uncomment if adding an item should exit ALL mode
      renderItems();
    } else {
        alert("Item name cannot be empty.");
    }
  }

  document.getElementById('editSectionBtn').onclick = function () {
    isAllModeActive = false; // Editing sections implies specific focus, exit ALL mode
    const editor = document.getElementById('sectionEditor');
    const list = document.getElementById('sectionEditList');
    list.innerHTML = '';
    sections.forEach((sec, index) => {
      const li = document.createElement('li');
      const input = document.createElement('input');
      input.type = 'text'; input.value = sec; input.className = 'rename-input';
      input.onchange = () => {
        const oldName = sections[index];
        const newName = input.value.trim().toLowerCase();
        if (newName && newName !== oldName && !sections.includes(newName)) {
          sections[index] = newName;
          items.forEach(item => { if (item.section === oldName) item.section = newName; });
          saveToStorage(); renderSections(); renderItems();
        } else if (newName !== oldName) {
          alert(`Section name "${newName}" is invalid or already exists.`); input.value = oldName;
        } else if (!newName) {
            alert("Section name cannot be empty."); input.value = oldName;
        }
      };
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn'; deleteBtn.textContent = '✕';
      deleteBtn.onclick = () => {
        const sectionToDelete = sections[index];
        if (confirm(`Delete section "${sectionToDelete}"? This will remove the section from all associated items.`)) {
          sections.splice(index, 1);
          items.forEach(item => { if (item.section === sectionToDelete) delete item.section; });
          saveToStorage(); renderSections(); renderItems();
          document.getElementById('editSectionBtn').click(); 
        }
      };
      li.appendChild(input); li.appendChild(deleteBtn);
      list.appendChild(li);
    });
    editor.classList.remove('hidden');
  };

  function closeSectionEditor() {
    document.getElementById('sectionEditor').classList.add('hidden');
    // isAllModeActive might have been set to false, UI will update on next renderItems if needed
  }

  function addSection() {
    const nameInput = document.getElementById('newSectionName');
    const name = nameInput.value.trim().toLowerCase();
    if (name && !sections.includes(name)) {
      sections.push(name);
      nameInput.value = '';
      saveToStorage();
      isAllModeActive = false; // Adding a section usually means focusing, exit ALL mode
      renderSections(); 
      renderItems(); 
    } else if (sections.includes(name)) {
      alert(`Section "${name}" already exists.`);
    } else if (!name) {
      alert("Section name cannot be empty.");
    }
  }

  function openPopup(item) { /* ... (no changes) ... */ }
  function savePopup() { /* ... (no changes other than renderItems call might be affected by isAllModeActive) ... */ }
  function closePopup() { /* ... (no changes) ... */ }
  function deleteCurrentItem() { /* ... (no changes other than renderItems call) ... */ }
  
  // Event listeners for top filter buttons
  document.querySelectorAll('#topButtonFilters .filter-btn').forEach(button => {
    button.addEventListener('click', () => {
        const filterType = button.dataset.filterType;
        const location = button.dataset.location;

        if (filterType === 'all') {
            isAllModeActive = true;
            activeLocationFilter = null;
            showLoadoutFilterActive = false;
            // When ALL is clicked, make all section buttons visually active for clarity,
            // though the filter itself is bypassed by isAllModeActive.
            document.querySelectorAll('#sectionFilters .section-filter-btn').forEach(sfBtn => sfBtn.classList.add('active'));
        } else {
            isAllModeActive = false; // Any other top filter deactivates ALL mode
            if (filterType === 'loadlist') {
                showLoadoutFilterActive = !showLoadoutFilterActive;
            } else if (filterType === 'location') {
                activeLocationFilter = (activeLocationFilter === location) ? null : location;
            }
        }
        renderItems();
    });
  });

  // Initial Load
  loadFromStorage();
  renderSections(); 
  renderItems();

</script>
</body>
</html>
